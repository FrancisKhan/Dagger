#include <iostream>

#include "gtest/gtest.h"
#include "file_tools.h"
#include "Library.h"
#include "Interpolation.h"
#include "additionalPrintFuncs.h"

class InterpolationTests : public ::testing::Test 
{
 protected:
	static std::string* url_;
	static std::string* target_;
	static Library* library_;
	static std::vector<std::string>* nucVec_;
	static std::vector < std::shared_ptr<Nuclide> >* nuclides_;

	static void SetUpTestSuite() 
	{
    	library_ = new Library;
		url_ = new std::string("https://www.polymtl.ca/merlin/downloads/libraries/ascii/draglibendfb7r0.gz");
    	target_ =  new std::string(File::getPrePath() + "draglibendfb7r0.gz");
		library_->downloadLibrary(*url_, *target_);
		library_->setXSLibraryPath(*target_);
		nucVec_ = new std::vector<std::string> {"Pu239"};
		nuclides_ = new std::vector < std::shared_ptr<Nuclide> > {library_->readNuclides(*nucVec_)};
  	}

	static void TearDownTestSuite() 
	{
    	delete library_;
		delete url_;
		delete target_;
		delete nucVec_;
		delete nuclides_;
    	library_ = nullptr;
		url_ = nullptr;
		target_ = nullptr;
		nucVec_ = nullptr;
		nuclides_ = nullptr;
  	}

	virtual void SetUp() {}
  	virtual void TearDown() {}
};

Library* InterpolationTests::library_ = nullptr;
std::string* InterpolationTests::url_ = nullptr;
std::string* InterpolationTests::target_ = nullptr;
std::vector<std::string>* InterpolationTests::nucVec_ = nullptr;
std::vector < std::shared_ptr<Nuclide> >* InterpolationTests::nuclides_ = nullptr;

TEST_F(InterpolationTests, LinLin)
{	
    CrossSectionSet xsSet = library_->getNuclide("Pu239")->getXSSet(XSKind::NTOT0);
    std::vector<double> vec = xsSet.getXS(300.0, LinLin(), 1222.5, LinLin()).getValues();

    std::vector<double> ref {6.151040080000e+00, 6.006264210000e+00, 5.894751070000e+00, 
	5.796453000000e+00, 5.845954900000e+00, 6.111144070000e+00, 6.577434060000e+00, 6.961059090000e+00, 
	7.254042150000e+00, 7.649480820000e+00, 7.944606780000e+00, 7.907044890000e+00, 7.696843150000e+00, 
	7.479269030000e+00, 7.317226890000e+00, 7.105926040000e+00, 6.896525860000e+00, 6.827847000000e+00, 
	6.845621110000e+00, 6.915193080000e+00, 7.036260130000e+00, 7.238356110000e+00, 7.719263080000e+00, 
	8.204987530000e+00, 8.454483030000e+00, 8.711734770000e+00, 8.974776270000e+00, 9.509425160000e+00, 
	1.003845980000e+01, 1.028818040000e+01, 1.074361040000e+01, 1.142817970000e+01, 1.184842970000e+01, 
	1.214863970000e+01, 1.252033040000e+01, 1.282674980000e+01, 1.322647000000e+01, 1.355494980000e+01, 
	1.384167000000e+01, 1.414873980000e+01, 1.428588010000e+01, 1.471827030000e+01, 1.517368030000e+01, 
	1.556690980000e+01, 1.595143030000e+01, 1.647966960000e+01, 1.712413020000e+01, 1.773407940000e+01, 
	1.826655010000e+01, 1.777301980000e+01, 2.007868923804e+01, 1.926060699441e+01, 2.107419971728e+01, 
	2.041138137349e+01, 2.286544892476e+01, 2.327005098013e+01, 2.879879871397e+01, 2.318670451133e+01, 
	2.152621586997e+01, 3.494699472633e+01, 2.486693703178e+01, 3.535084450762e+01, 5.035057328151e+01, 
	4.428947774795e+01, 4.700928512136e+01, 5.514913822343e+01, 9.911876292216e+01, 1.365133953956e+02, 
	1.280455458235e+02, 1.574484654216e+02, 9.463940266088e+01, 4.894104585493e+01, 1.452115374613e+02, 
	9.291325980372e+00, 1.665552925622e+01, 1.846594543093e+01, 1.129212757670e+01, 8.527055515403e+01, 
	2.721035571720e+01, 1.104958514151e+02, 1.071672478638e+02, 2.925748649244e+02, 1.523677769401e+02, 
	3.318610919350e+02, 1.640211426613e+01, 1.728821924831e+01, 3.831341740404e+02, 2.500240974455e+01, 
	1.690870597098e+01, 1.690422869579e+01, 1.750438941818e+01, 1.825583526907e+01, 1.910818918652e+01, 
	2.001870359543e+01, 2.114906138930e+01, 2.234666567672e+01, 2.277924112149e+01, 2.323703713076e+01, 
	2.397529163596e+01, 2.547122086450e+01, 2.652706692161e+01, 2.704837956145e+01, 2.790400221539e+01, 
	2.892412571053e+01, 3.004226229182e+01, 3.127391191576e+01, 3.263396920199e+01, 3.423921239526e+01, 
	3.545196916794e+01, 3.614352690129e+01, 3.748793229141e+01, 3.891883778679e+01, 4.000701673459e+01, 
	4.178743686491e+01, 4.438229891924e+01, 4.629922689374e+01, 4.749237383015e+01, 4.856021719031e+01, 
	4.928928857858e+01, 5.044812343360e+01, 5.208779829596e+01, 5.330483153344e+01, 5.419718123015e+01, 
	5.568032218027e+01, 5.704764479559e+01, 5.806295057421e+01, 5.973145596847e+01, 6.171270051539e+01, 
	6.391519412219e+01, 6.812641405961e+01, 7.235638614327e+01, 7.815912608677e+01, 8.479575401392e+01, 
	9.527105250825e+01, 1.249686802098e+02, 1.847495502055e+02, 2.691809139684e+02, 3.346779350607e+02, 
	4.703400691173e+02, 7.791389801694e+02, 1.053644413568e+03, 1.703052197877e+03, 3.381259659974e+03, 
	4.541564353902e+03, 5.054881963012e+03, 5.300769656166e+03, 3.995784801468e+03, 2.405982317952e+03, 
	1.514106398246e+03, 1.138256262769e+03, 1.023551068771e+03, 8.753735331471e+02, 8.129405012015e+02, 
	7.661194083729e+02, 7.100438123606e+02, 7.161518806005e+02, 6.747820675754e+02, 6.823508898246e+02, 
	6.187689064442e+02, 6.977148776354e+02, 6.357872723998e+02, 8.152199517540e+02, 8.681055361393e+02, 
	7.605397052812e+02, 9.915166325016e+02, 1.081190359144e+03, 1.209724551928e+03, 1.413149691977e+03, 
	1.699604457475e+03, 2.011877656381e+03, 2.439950388705e+03, 3.768327941973e+03};

    EXPECT_TRUE(Numerics::areVectorsEqual(vec, ref, 1.0E-9));
}

TEST_F(InterpolationTests, SqrtLogLin)
{	
    CrossSectionSet xsSet = library_->getNuclide("Pu239")->getXSSet(XSKind::NTOT0);
    std::vector<double> vec = xsSet.getXS(300.0, Sqrt(), 1222.5, LogLin()).getValues();

    std::vector<double> ref {6.151040080000e+00, 6.006264210000e+00, 5.894751070000e+00, 
	5.796453000000e+00, 5.845954900000e+00, 6.111144070000e+00, 6.577434060000e+00, 6.961059090000e+00, 
	7.254042150000e+00, 7.649480820000e+00, 7.944606780000e+00, 7.907044890000e+00, 7.696843150000e+00, 
	7.479269030000e+00, 7.317226890000e+00, 7.105926040000e+00, 6.896525860000e+00, 6.827847000000e+00, 
	6.845621110000e+00, 6.915193080000e+00, 7.036260130000e+00, 7.238356110000e+00, 7.719263080000e+00, 
	8.204987530000e+00, 8.454483030000e+00, 8.711734770000e+00, 8.974776270000e+00, 9.509425160000e+00, 
	1.003845980000e+01, 1.028818040000e+01, 1.074361040000e+01, 1.142817970000e+01, 1.184842970000e+01, 
	1.214863970000e+01, 1.252033040000e+01, 1.282674980000e+01, 1.322647000000e+01, 1.355494980000e+01, 
	1.384167000000e+01, 1.414873980000e+01, 1.428588010000e+01, 1.471827030000e+01, 1.517368030000e+01, 
	1.556690980000e+01, 1.595143030000e+01, 1.647966960000e+01, 1.712413020000e+01, 1.773407940000e+01, 
	1.826655010000e+01, 1.777301980000e+01, 2.007869200049e+01, 1.926054909993e+01, 2.107428661190e+01, 
	2.040811600260e+01, 2.286634942750e+01, 2.327009835948e+01, 2.879889729887e+01, 2.318670673911e+01, 
	2.152622702558e+01, 3.494694522502e+01, 2.486705898611e+01, 3.535080838971e+01, 5.034856427919e+01, 
	4.429248190031e+01, 4.698606220792e+01, 5.515386710760e+01, 9.912614752808e+01, 1.364993153703e+02, 
	1.280230120910e+02, 1.575073570512e+02, 9.464364501982e+01, 4.893694414141e+01, 1.452107912658e+02, 
	9.291405757789e+00, 1.665558216046e+01, 1.846589752248e+01, 1.129338181775e+01, 8.526913593462e+01, 
	2.723763593890e+01, 1.104773717995e+02, 1.071704394395e+02, 2.925694803762e+02, 1.524016673463e+02, 
	3.318081933164e+02, 1.640344308773e+01, 1.729125017303e+01, 3.831069845229e+02, 2.501343109812e+01, 
	1.690879669182e+01, 1.690427713890e+01, 1.750443955997e+01, 1.825588317752e+01, 1.910823369203e+01, 
	2.001872526617e+01, 2.114908869077e+01, 2.234670073086e+01, 2.277927957300e+01, 2.323707951988e+01, 
	2.397534188358e+01, 2.547129044369e+01, 2.652715265222e+01, 2.704846358780e+01, 2.790406956123e+01, 
	2.892418870662e+01, 3.004233867131e+01, 3.127400603396e+01, 3.263408180521e+01, 3.423932436356e+01, 
	3.545207433594e+01, 3.614366090105e+01, 3.748809275976e+01, 3.891903010400e+01, 4.000723634287e+01, 
	4.178770148939e+01, 4.438263107686e+01, 4.629962361946e+01, 4.749287168863e+01, 4.856075095334e+01, 
	4.928987633940e+01, 5.044880588867e+01, 5.208864404774e+01, 5.330583717378e+01, 5.419834112615e+01, 
	5.568174874728e+01, 5.704932786575e+01, 5.806495914443e+01, 5.973351962419e+01, 6.171578969254e+01, 
	6.391782609263e+01, 6.813043464761e+01, 7.235947095325e+01, 7.816384919329e+01, 8.480275655374e+01, 
	9.528597363048e+01, 1.249814686118e+02, 1.847712511983e+02, 2.692443107197e+02, 3.347571971327e+02, 
	4.705098174881e+02, 7.795588762076e+02, 1.054293090139e+03, 1.704167037329e+03, 3.381503699507e+03, 
	4.538902175875e+03, 5.050222490831e+03, 5.295989124531e+03, 3.996728961085e+03, 2.407853229531e+03, 
	1.514943758800e+03, 1.139107321035e+03, 1.023869951674e+03, 8.755775686349e+02, 8.130938216722e+02, 
	7.662348740262e+02, 7.102741133207e+02, 7.162222798089e+02, 6.750533861979e+02, 6.826029374599e+02, 
	6.192652806426e+02, 6.979907124808e+02, 6.361850939879e+02, 8.152535624300e+02, 8.681364591529e+02, 
	7.612205913179e+02, 9.915454799155e+02, 1.081219019264e+03, 1.209753369040e+03, 1.413180705625e+03, 
	1.699638566936e+03, 2.011917094811e+03, 2.439996990375e+03, 3.768402069756e+03};

    EXPECT_TRUE(Numerics::areVectorsEqual(vec, ref, 1.0E-9));
}

TEST_F(InterpolationTests, MatrixLinLin)
{	
    Eigen::MatrixXd mat = library_->getNuclide("Pu239")->getXSMatrixSet(XSMatrixKind::SCAT01).getXSMatrix(300.0, LinLin(), 1222.5, LinLin()).getValues();
	std::vector<double> vec = Numerics::eigenVecTOStdVec(mat.diagonal(1)); 

	std::vector<double> ref {5.518682670000e-02, 3.594385090000e-02, 6.433157620000e-02, 
	4.009336610000e-02, 3.918724130000e-02, 2.814282100000e-02, 1.758809200000e-02, 2.552001920000e-02, 
	3.354626150000e-02, 2.366414110000e-02, 2.222497200000e-02, 1.915073390000e-02, 1.226634440000e-02, 
	1.581882500000e-02, 1.400793440000e-02, 7.254477590000e-03, 3.868573810000e-03, 5.558215550000e-03, 
	9.505683560000e-03, 1.438424270000e-02, 1.915855520000e-02, 3.012711370000e-02, 1.569265500000e-02, 
	4.804251720000e-02, 3.929188850000e-02, 2.813378350000e-02, 2.884934280000e-02, -1.744213860000e-03, 
	-4.957551140000e-02, -2.713896890000e-02, -1.126980040000e-02, -3.220964600000e-02, -1.493796464253e-01, 
	-6.103229423318e-02, -1.020840503660e-01, -1.127544376457e-01, -8.157550867286e-02, -2.427833558884e-01, 
	-1.131897421263e-01, -4.215301906959e-01, -2.852310867838e-01, -7.773236974827e-02, -3.140070202260e-01, 
	-1.101889362147e-01, -1.661554606682e-01, -1.724239089152e-01, -1.200578145761e-01, -3.640431616036e-01, 
	-9.993105327468e-02, -7.119921606948e-01, -8.540504368733e-02, -3.059904331544e-01, -1.098676136378e-01, 
	-6.944267323154e-01, -1.963441217292e-01, -1.574625462476e-01, -4.093273428232e-01, -2.537990910400e-01, 
	-3.309511741959e-01, -1.078792814296e-01, -1.593994039604e-01, -1.489662357328e-01, -1.164709339630e-01, 
	-1.009174047233e-01, -4.526691528801e-01, -9.729289348015e-02, -2.868547533387e-01, -2.726918697463e-01, 
	-1.471893144076e-01, -1.854049410898e-01, -3.074765580755e-01, -4.885614630022e-01, -1.248374516714e-01, 
	-2.955211914065e-01, -2.430103195741e-01, -2.580848108946e-01, -2.934970659863e-01, -2.544843778662e-01, 
	-3.730334419886e-01, -1.869554801626e-01, -1.459030645651e-01, -1.153772596064e-01, -1.235200515903e-01, 
	-1.447415601195e-01, -2.910156750722e-01, -2.631212901968e-01, -1.109618003321e-01, -1.104921378061e-01, 
	-1.639077047282e-01, -4.033819410508e-01, -1.214672859596e-01, -7.666749074506e-01, -1.027737988892e-01, 
	-7.258506257702e-01, -6.512969816785e-02, -6.891575002630e-01, -2.585187362842e-01, -7.202560142235e-01, 
	-3.465470728523e-01, -7.683378134075e-02, -4.279578651704e-01, -5.156937286668e-01, -4.951409386019e-01, 
	-5.149847824004e-01, -5.147590828087e-01, -5.054360188240e-01, -5.188539554886e-01, -1.580447979593e-01, 
	-1.196861551415e-01, -5.779804378953e-01, -2.615242509292e-01, -3.174164933464e-01, -5.851946758431e-01, 
	-4.905538854081e-01, -1.369795605669e-01, -8.634986916257e-02, 4.495614632252e-02, 2.227336681224e-01, 
	1.006542050779e-01, -1.251346451332e-01, 7.005207937277e-02, 2.584761245509e-01, 3.355380940357e-02, 
	5.838889532710e-02, 2.535007822223e-01, 6.086228262117e-02, -7.018680307970e-02, -2.458141624741e-02, 
	-4.944163696249e-01, -5.517609818096e-02, -4.201203000664e-01, -7.031483710184e-02, -5.064629963657e-01, 
	-3.676801967240e-01, -3.188435670645e-01, -2.728561548975e-01, -2.171147051704e-01, -6.600506332918e-01, 
	-4.009757190066e-01, -1.386744383692e-01, -6.500232058832e-01, -5.291545085221e-01, -8.776468147363e-02, 
	8.521066142678e-02, -5.281290427088e-01, -5.740532438959e-01, -2.549878121571e-01, -2.179152225717e-01, 
	-7.568874853359e-02, -2.197647385154e-01, -2.305069447847e-01, -5.377064864958e-02, -2.126348262643e-01, 
	-2.109902047266e-01, -5.366543864124e-02, -2.187502715736e-01, -2.791486139824e-02, -7.713999445158e-02, 
	-2.004307683824e-01, -1.911781725505e-01, -2.048771539521e-01, -1.930582776244e-01, -1.448554571041e-01, 
	-1.488297640611e-01, -1.708159715036e-01, -1.894511989193e-01, -1.990912360279e-01, -1.443416028516e-01, 
	-1.020578410436e-01, -1.132971335133e-01, -1.494549534211e-01};

    EXPECT_TRUE(Numerics::areVectorsEqual(vec, ref, 1.0E-9));
}

TEST_F(InterpolationTests, MatrixSqrtLogLin)
{	
    Eigen::MatrixXd mat = library_->getNuclide("Pu239")->getXSMatrixSet(XSMatrixKind::SCAT01).getXSMatrix(300.0, Sqrt(), 1222.5, LogLin()).getValues();
	std::vector<double> vec = Numerics::eigenVecTOStdVec(mat.diagonal(1)); 

	//PrintFuncs::createCppVector(vec, "%13.12e");

	std::vector<double> ref {5.518682670000e-02, 3.594385090000e-02, 6.433157620000e-02, 
	4.009336610000e-02, 3.918724130000e-02, 2.814282100000e-02, 1.758809200000e-02, 2.552001920000e-02, 
	3.354626150000e-02, 2.366414110000e-02, 2.222497200000e-02, 1.915073390000e-02, 1.226634440000e-02, 
	1.581882500000e-02, 1.400793440000e-02, 7.254477590000e-03, 3.868573810000e-03, 5.558215550000e-03, 
	9.505683560000e-03, 1.438424270000e-02, 1.915855520000e-02, 3.012711370000e-02, 1.569265500000e-02, 
	4.804251720000e-02, 3.929188850000e-02, 2.813378350000e-02, 2.884934280000e-02, -1.744213860000e-03, 
	-4.957551140000e-02, -2.713896890000e-02, -1.126980040000e-02, -3.220964600000e-02, -1.493801798783e-01, 
	-6.103260658895e-02, -1.020846818778e-01, -1.127552582639e-01, -8.157624356217e-02, -2.427856866906e-01, 
	-1.131913499002e-01, -4.215365938988e-01, -2.852357249102e-01, -7.773406830441e-02, -3.140142220876e-01, 
	-1.101921761627e-01, -1.661603400470e-01, -1.724307967713e-01, -1.200643483882e-01, -3.640648670949e-01, 
	-9.993638215383e-02, -7.120330567195e-01, -8.541123883272e-02, -3.060045214187e-01, -1.098731972778e-01, 
	-6.945144020504e-01, -1.963482343317e-01, -1.574768774877e-01, -4.094749012362e-01, -2.540388129000e-01, 
	-3.310489579847e-01, -1.079177326159e-01, -1.594103359888e-01, -1.490859079629e-01, -1.165514739141e-01, 
	-1.009252106453e-01, -4.526860834436e-01, -9.732983913814e-02, -2.870166823022e-01, -2.727101023813e-01, 
	-1.471036023503e-01, -1.885267921255e-01, -3.074948989263e-01, -4.886073113157e-01, -1.248204201095e-01, 
	-2.955208639274e-01, -2.430107341508e-01, -2.580847503700e-01, -2.935088615550e-01, -2.544812437624e-01, 
	-3.731709376531e-01, -1.869570511967e-01, -1.459170608668e-01, -1.153705951056e-01, -1.235672114098e-01, 
	-1.447424166063e-01, -2.910203137322e-01, -2.631418713173e-01, -1.108803959551e-01, -1.104949107722e-01, 
	-1.639117349194e-01, -4.033920103956e-01, -1.214708043979e-01, -7.666977316239e-01, -1.021029762982e-01, 
	-7.209763289644e-01, -6.458863761737e-02, -6.786258238939e-01, -2.551583002154e-01, -7.138189276561e-01, 
	-3.477950483729e-01, -7.628295791060e-02, -4.153661132009e-01, -5.118584801016e-01, -4.930174211280e-01, 
	-5.123074737292e-01, -5.124902325486e-01, -5.030573544695e-01, -5.176957849078e-01, -1.552846987972e-01, 
	-1.077314411879e-01, -5.673156566434e-01, -2.560513269662e-01, -3.041062173699e-01, -5.750990043489e-01, 
	-4.876463571173e-01, -1.332750839684e-01, -7.419482195345e-02, 4.967748715798e-02, 2.253473688946e-01, 
	1.101053716895e-01, -1.147530384623e-01, 7.325472588640e-02, 2.619834776371e-01, 4.391307066416e-02, 
	6.239516017115e-02, 2.568510476884e-01, 7.071066000219e-02, -5.992105269589e-02, -1.488042706964e-02, 
	-4.810282228233e-01, -5.236293954333e-02, -4.080133768108e-01, -6.819810645324e-02, -4.972143277728e-01, 
	-3.701397676460e-01, -3.216266896812e-01, -2.734279651721e-01, -2.118679059974e-01, -6.506585573844e-01, 
	-4.006741666553e-01, -1.333653002806e-01, -6.351968110174e-01, -5.281545127746e-01, -8.346122111736e-02, 
	1.043624794510e-01, -5.108611906234e-01, -5.702824862666e-01, -2.560992918328e-01, -2.185517603169e-01, 
	-7.402652572257e-02, -2.132977734423e-01, -2.284927625993e-01, -5.126879361397e-02, -2.060198577404e-01, 
	-2.091438309705e-01, -5.075454961936e-02, -2.113240619469e-01, -2.607418543757e-02, -6.804376175394e-02, 
	-1.959976170961e-01, -1.865021977473e-01, -2.002265039576e-01, -1.889649127127e-01, -1.402046315492e-01, 
	-1.427417124925e-01, -1.654711612458e-01, -1.852587365452e-01, -1.965540939174e-01, -1.422535703742e-01, 
	-9.809912691696e-02, -1.077953096924e-01, -1.470118396788e-01};

    EXPECT_TRUE(Numerics::areVectorsEqual(vec, ref, 1.0E-9));
}

